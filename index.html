<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        var bearer_token = 'Bearer f7199f36032451871135ef0c64b79fe055842aca'
        var api_key = 'b3d39321-5dc4-4298-98c6-0399432a948b';
        var results = [];

        function sendRequests() {
            $('#result').html('');
            var lines = $('#myTextarea').val().split('\n');

            $.each(lines, function (index, value) {
                var cardNameTrimmed = value.trim().replace(/^\d+\s*/, '');
                $.ajax({
                    url: 'https://mtgspot.cn-panel.pl/products?s_title=' + cardNameTrimmed + '&limit=25&offset=0&order_by=title&sort_by=asc',
                    type: 'GET',
                    success: function (response) {
                        if (response.count > 0) {
                            var data = response.data.filter(function(item) {
                                return item.stock !== 0;
                            });

                            if (data.length > 0) {
                                data.sort((a, b) => a.price - b.price);

                                var cheapestCard = data[0];
                                var urlElements = [
                                    cheapestCard.expansion_name,
                                    cheapestCard.id_expansion,
                                    cheapestCard.title,
                                    cheapestCard.id_product,
                                    cheapestCard.id_article
                                ]

                                $('#result').append('<a href="https://mtgspot.pl/single/' + urlElements.join('/') + '" target="_blank">' + cheapestCard.title + ' - ' + cheapestCard.price + '</a><br />');
                                results.push(cheapestCard);
                            } else {
                                $('#result').append('<i>' + cardNameTrimmed + '</i><br />')
                            }
                        } else {
                            $('#result').append('<i>' + cardNameTrimmed + '</i><br />')
                        }
                    },
                });
            });
        }

        function addToBasket() {
            if (results.length == 0) {
                alert('Nie znaleziono kart na stanie! :(');
                return;
            }

            $.each(results, function (index, value) {
                $.ajax({
                    url: 'https://gateway.mtgspot.pl/api/shop/carts/single',
                    type: 'POST',
                    data: {
                        'quantity': 1,
                        'id_article': value.id_article
                    },
                    headers: {
                        'Authorization': bearer_token,
                        'x-api-key': api_key
                    },
                    success: function (response) {
                        console.log(response);
                    }
                })
            });

            alert('Przejdź teraz do https://mtgspot.pl/order');
        }
    </script>
</head>

<body>
    <div>
        <input id="user_id" type="text" size="55" placeholder="user_id">
        <br />
        <textarea id="myTextarea" rows="25" cols="60" placeholder="Black Lotus"></textarea>
        <br />
        <button onclick="sendRequests()">Wyślij zapytania</button>
        <button onclick="addToBasket()">Dodaj do koszyka</button>
        <hr />
        <div id="result"></div>
    </div>
</body>

</html>
