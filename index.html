<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MTG Spot cheapest singles</title>
    <style>
        table, th, td {
            border: 0px;
            border-collapse: collapse;
            padding: 5px;
        }
        
        tr:nth-child(even) {
            background-color: #D6EEEE;
        }

        a {
            color: #0060B6;
            text-decoration: none;
        }

        a:hover {
            color: #f44336;
            text-decoration: none;
            cursor: pointer;
        }

        img {
           border-radius: 8px;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip span {
            display: none;
            position: fixed;
            overflow: hidden;
            z-index: 999;
        }

        .tooltip:hover span {
            display: block;
        }

        #addToBasketButton {
            background-color: #bbeebb;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
		const bearer_token = 'Bearer f7199f36032451871135ef0c64b79fe055842aca';
		const api_key = 'b3d39321-5dc4-4298-98c6-0399432a948b';
		const currency = 'PLN';

		var results = [];

		function sendRequests() {
			$('#result').html('');
			$('#addToBasketButton').prop('disabled', true);

			results = [];
			var lines = $('#cards').val().trim().split('\n');

			$.each(lines, function (index, value) {
				var cardNameTrimmed = value.trim().replace(/^\d+\s*/, '');
				console.log('Looking for:', cardNameTrimmed);

				$.ajax({
					url: 'https://mtgspot.cn-panel.pl/products?s_title=' + cardNameTrimmed + '&limit=300&offset=0&order_by=title&sort_by=asc',
					type: 'GET',
					success: function (response) {
						if (response.count > 0) {
							var data = response.data.filter(function(item) {
								return item.stock !== 0;
							});

							if (data.length > 0) {
								data.sort((a, b) => a.price - b.price);

								var cheapestCard = data[0];
								var urlElements = [
									cheapestCard.expansion_name,
									cheapestCard.id_expansion,
									cheapestCard.title,
									cheapestCard.id_product,
									cheapestCard.id_article
								];

								$('#result').append('<tr><td><a class="tooltip" href="https://mtgspot.pl/single/' + urlElements.join('/') + '" target="_blank">' + cheapestCard.title + '<span><img alt="" src="' + cheapestCard.image + '" /></span></a><td>' + cheapestCard.price + ' ' + currency + '<td><input type="checkbox" checked>');
								results.push(cheapestCard);
							} else {
								$('#result').append('<tr><td colspan="3"><i style="color: #db9494">' + cardNameTrimmed + '</i>');
							}
						} else {
							$('#result').append('<tr><td colspan="3"><i style="color: #db9494">' + cardNameTrimmed + '</i>');
						}

						if (results.length > 0) {
							$('#addToBasketButton').prop('disabled', false);
						}
					}
				});
			});
		}

		function addToBasket() {
			$.each(results, function (index, value) {
				$.ajax({
					url: 'https://gateway.mtgspot.pl/api/shop/carts/single',
					type: 'POST',
					data: {
						'quantity': 1,
						'id_article': value.id_article
					},
					headers: {
						'Authorization': bearer_token,
						'x-api-key': api_key
					},
					success: function (response) {
						console.log('Added to basket:', response);
						window.open('https://mtgspot.pl/order', '_blank').focus();
					}
				});
			});
		}

        $(document).ready(function() {
            $(document).on('mousemove', '.tooltip', function(e) {
                var x = e.clientX + 20;
                var y = e.clientY + 20;
                $(this).find('span').css({ top: y + 'px', left: x + 'px' });
            });
        });
    </script>
</head>

<body>
    <div>
        <textarea id="cards" rows="35" cols="60" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" autofocus placeholder="Black Lotus
Mana Crypt
Sol Ring"></textarea>
        <br />
        <button onclick="sendRequests()">Sprawdź najtańsze dostępne single</button>
        <button id="addToBasketButton" onclick="addToBasket()" disabled>Dodaj znalezione karty do koszyka MTG Spot</button>
        <hr />
        <div id="result"></div>
    </div>
</body>
</html>